name: HPCI-Style Remote Execution

on:
  workflow_dispatch:
    inputs:
      command:
        description: 'Command to execute remotely'
        required: false
        default: 'hostname && echo "Hello from NCI"'
  push:
    branches: [ feature/v3.3.0-remote-execution ]

jobs:
  hpci-style-remote:
    permissions:
      contents: "read"
      id-token: "write"
    runs-on: self-hosted

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install qxub locally on runner
      run: |
        python -m pip install --upgrade pip
        pip install -e .

    - name: Set up HPCI authentication
      uses: swarbricklab/hpci-scripts/.github/actions/setup-hpci@main
      with:
        submodule_token: ${{ secrets.SUBMODULE_TOKEN }}
        project_id: ${{ secrets.PROJECT_ID }}
        project_number: ${{ secrets.PROJECT_NUMBER }}
        registry_sa: ${{ secrets.REGISTRY_SA }}

    - name: Configure qxub for remote execution
      run: |
        mkdir -p ~/.config/qxub
        cat > ~/.config/qxub/config.yaml << 'EOF'
        defaults:
          platform: gadi
          project: a56

        platforms:
          gadi:
            remote:
              host: ${{ secrets.USER_NAME }}@gadi.nci.org.au
              ssh_key: atlas_key
              working_dir: /scratch/a56/${{ secrets.USER_NAME }}/ci-jobs
              conda_init: |
                eval "$(conda shell.bash hook)"
                conda activate qxub
        EOF
        echo "Configuration created:"
        cat ~/.config/qxub/config.yaml

    - name: Execute command remotely via qxub
      run: |
        # Get command from input or use default
        COMMAND="${{ github.event.inputs.command }}"
        if [ -z "$COMMAND" ]; then
          COMMAND="hostname && echo 'Hello from NCI'"
        fi

        echo "Executing remotely: $COMMAND"
        qxub exec --platform gadi --queue copyq --time "0:01:00" --storage gdata/a56 -vv -- $COMMAND

    - name: Test with conda environment
      run: |
        echo "Testing execution with conda environment..."
        qxub exec --platform gadi --env qxub --queue copyq --time "0:01:00" --storage gdata/a56 -vv -- python --version

    - name: Clean up
      if: always()
      run: |
        rm -f atlas_key atlas_key.pub
        echo "âœ… Remote execution completed and SSH keys cleaned up"
