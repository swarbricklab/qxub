name: HPCI-Style Remote Execution

on:
  workflow_dispatch:
    inputs:
      command:
        description: 'Command to run remotely (will use qxub exec)'
        required: true
        default: 'hostname'
      queue:
        description: 'PBS queue to use'
        required: false
        default: 'copyq'
      walltime:
        description: 'Job walltime'
        required: false
        default: '0:01:00'
  push:
    branches: [ feature/v3.3.0-remote-execution ]

jobs:
  hpci-style-remote:
    permissions:
      contents: "read"
      id-token: "write"
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install qxub locally on runner
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Set up HPCI authentication
        uses: swarbricklab/hpci-scripts/.github/actions/setup-hpci@main
        with:
          submodule_token: ${{ secrets.SUBMODULE_TOKEN }}
          project_id: ${{ secrets.PROJECT_ID }}
          project_number: ${{ secrets.PROJECT_NUMBER }}
          registry_sa: ${{ secrets.REGISTRY_SA }}

      - name: Debug SSH key format
        run: |
          echo "=== SSH Key Debugging ==="
          echo "SSH client version:"
          ssh -V || echo "Could not get SSH version"

          echo "OpenSSL version:"
          openssl version || echo "Could not get OpenSSL version"

          echo "Key file size and type:"
          ls -la atlas_key* || echo "No atlas_key files found"

          echo "Key file format check:"
          file atlas_key || echo "Could not check key file format"

          echo "Key file contents (first few lines):"
          head -3 atlas_key || echo "Could not read key file"

          echo "Key file contents (last few lines):"
          tail -3 atlas_key || echo "Could not read key file"

          echo "SSH key validation:"
          ssh-keygen -l -f atlas_key || echo "Key validation failed"

          echo "Key permissions:"
          stat -c "%a %n" atlas_key* || echo "Could not check permissions"

          echo "Converting key to traditional format for compatibility..."
          # Try to convert the key to the traditional format that older SSH clients can read
          cp atlas_key atlas_key.backup

          # Alternative approach: Try to extract and re-create the key in PEM format
          # using the public key to verify we have the right private key
          if ssh-keygen -y -f atlas_key > atlas_key_extracted.pub 2>/dev/null; then
            echo "Successfully extracted public key"
            # Compare with the provided public key
            if cmp -s atlas_key.pub atlas_key_extracted.pub; then
              echo "Public keys match - private key is valid"
            else
              echo "WARNING: Public keys don't match"
            fi
          else
            echo "Could not extract public key from private key"
          fi

          # Try using ssh-agent to load the key (bypasses direct file loading)
          echo "Testing with ssh-agent..."
          eval $(ssh-agent -s)
          ssh-add atlas_key 2>&1 | head -5 || echo "ssh-add failed"
          ssh-add -l || echo "No keys in agent"

      - name: Work around SSH key compatibility issue
        run: |
          echo "=== SSH Key Compatibility Investigation ==="

          # The issue is OpenSSL 3.x libcrypto compatibility with OpenSSH key format
          echo "Investigating OpenSSL/SSH compatibility options..."

          # Check OpenSSL configuration
          echo "OpenSSL version and config:"
          openssl version -a
          echo ""

          # Try setting OpenSSL legacy provider (may help with older key formats)
          echo "Testing with OpenSSL legacy provider..."
          export OPENSSL_CONF=/etc/ssl/openssl.cnf

          # Try to create a compatible version using different SSH options
          echo "Attempting key format debugging..."

          # Check if we can read the key with specific OpenSSL settings
          openssl pkey -in atlas_key -noout -text 2>&1 || echo "OpenSSL pkey reading failed"

          # Try with SSH_USE_STRONG_RNG=0 (sometimes helps with entropy issues)
          echo "Testing with SSH_USE_STRONG_RNG=0..."
          SSH_USE_STRONG_RNG=0 ssh-keygen -l -f atlas_key 2>&1 || echo "SSH_USE_STRONG_RNG=0 failed"

          # Try different SSH client debugging
          echo "Testing SSH with different debugging levels..."
          ssh -o LogLevel=DEBUG3 -o BatchMode=yes -o ConnectTimeout=5 \
              -i atlas_key \
              ${{ secrets.USER_NAME }}@gadi.nci.org.au \
              "echo test" 2>&1 | head -50 || echo "SSH debug test completed"

      - name: Configure SSH for Gadi access
        run: |
          mkdir -p ~/.ssh

          # Add Gadi host key
          ssh-keyscan -t ed25519 gadi.nci.org.au >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

          # Configure SSH to use atlas_key for Gadi connections
          cat >> ~/.ssh/config << EOF
          Host gadi.nci.org.au gadi
              HostName gadi.nci.org.au
              User ${{ secrets.USER_NAME }}
              IdentityFile ${{ github.workspace }}/atlas_key
              IdentitiesOnly yes
              StrictHostKeyChecking yes
          EOF
          chmod 600 ~/.ssh/config

          echo "SSH config created:"
          cat ~/.ssh/config

      - name: Test SSH key manually
        run: |
          echo "=== Manual SSH Key Test ==="
          echo "Testing SSH connection with atlas_key..."

          # Test with environment variables that might help with OpenSSL 3.x compatibility
          echo "Testing with SSH_USE_STRONG_RNG=0..."
          SSH_USE_STRONG_RNG=0 ssh -i ${{ github.workspace }}/atlas_key \
              -o BatchMode=yes \
              -o ConnectTimeout=10 \
              -o StrictHostKeyChecking=yes \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              ${{ secrets.USER_NAME }}@gadi.nci.org.au \
              "echo 'SSH_USE_STRONG_RNG=0 test successful!' && hostname" || echo "SSH_USE_STRONG_RNG=0 test failed with exit code $?"

      - name: Configure qxub for remote execution
        run: |
          mkdir -p ~/.config/qxub
          cat > ~/.config/qxub/config.yaml << 'EOFCONFIG'
          defaults:
            platform: gadi
            project: a56

          platforms:
            gadi:
              remote:
                host: gadi.nci.org.au
                working_dir: /scratch/a56/${{ secrets.USER_NAME }}/ci-jobs
                conda_init: |
                  eval "$(conda shell.bash hook)"
                  conda activate qxub
          EOFCONFIG
          echo "Generated qxub config:"
          cat ~/.config/qxub/config.yaml

      - name: Execute qxub remote command
        run: |
          QUEUE="${{ github.event.inputs.queue || 'copyq' }}"
          WALLTIME="${{ github.event.inputs.walltime || '0:01:00' }}"
          COMMAND="${{ github.event.inputs.command || 'hostname' }}"

          echo "Executing command on NCI Gadi via qxub:"
          echo "  Queue: $QUEUE"
          echo "  Walltime: $WALLTIME"
          echo "  Command: $COMMAND"

          qxub exec --platform gadi --queue "$QUEUE" --time "$WALLTIME" -vv -- "$COMMAND"

      - name: Clean up
        if: always()
        run: |
          rm -f atlas_key atlas_key.pub
          echo "âœ… Remote execution completed and SSH keys cleaned up"
