name: HPCI-Style Remote Execution

on:
  workflow_dispatch:
    inputs:
      command:
        description: 'Command to run remotely (will use qxub exec)'
        required: true
        default: 'hostname'
      queue:
        description: 'PBS queue to use'
        required: false
        default: 'copyq'
      walltime:
        description: 'Job walltime'
        required: false
        default: '0:01:00'
  push:
    branches: [ feature/v3.3.0-remote-execution ]

jobs:
  hpci-style-remote:
    permissions:
      contents: "read"
      id-token: "write"
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install qxub locally on runner
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Set up HPCI authentication
        uses: swarbricklab/hpci-scripts/.github/actions/setup-hpci@main
        with:
          submodule_token: ${{ secrets.SUBMODULE_TOKEN }}
          project_id: ${{ secrets.PROJECT_ID }}
          project_number: ${{ secrets.PROJECT_NUMBER }}
          registry_sa: ${{ secrets.REGISTRY_SA }}

      - name: Configure SSH for Gadi access
        run: |
          mkdir -p ~/.ssh

          # Add Gadi host key
          ssh-keyscan -t ed25519 gadi.nci.org.au >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

          # Configure SSH to use atlas_key for Gadi connections
          cat >> ~/.ssh/config << EOF
          Host gadi.nci.org.au gadi
              HostName gadi.nci.org.au
              User ${{ secrets.USER_NAME }}
              IdentityFile ${{ github.workspace }}/atlas_key
              IdentitiesOnly yes
              StrictHostKeyChecking yes
          EOF
          chmod 600 ~/.ssh/config

          echo "SSH config created:"
          cat ~/.ssh/config

      - name: Configure qxub for remote execution
        run: |
          mkdir -p ~/.config/qxub
          cat > ~/.config/qxub/config.yaml << 'EOFCONFIG'
          defaults:
            platform: gadi
            project: a56

          platforms:
            gadi:
              remote:
                host: gadi.nci.org.au
                working_dir: /scratch/a56/${{ secrets.USER_NAME }}/ci-jobs
                conda_init: |
                  eval "$(conda shell.bash hook)"
                  conda activate qxub
          EOFCONFIG
          echo "Generated qxub config:"
          cat ~/.config/qxub/config.yaml

      - name: Execute qxub remote command
        run: |
          QUEUE="${{ github.event.inputs.queue || 'copyq' }}"
          WALLTIME="${{ github.event.inputs.walltime || '0:01:00' }}"
          COMMAND="${{ github.event.inputs.command || 'hostname' }}"

          echo "Executing command on NCI Gadi via qxub:"
          echo "  Queue: $QUEUE"
          echo "  Walltime: $WALLTIME"
          echo "  Command: $COMMAND"

          qxub exec --platform gadi --queue "$QUEUE" --time "$WALLTIME" -vv -- "$COMMAND"

      - name: Clean up
        if: always()
        run: |
          rm -f atlas_key atlas_key.pub
          echo "âœ… Remote execution completed and SSH keys cleaned up"
