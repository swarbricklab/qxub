name: Test Remote Execution v3.3.0 (Secure)

on:
  push:
    branches: [ main, feature/v3.3.0-remote-execution ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allow manual trigger

jobs:
  test-remote-execution-secure:
    permissions:
      contents: "read"
      id-token: "write"
    runs-on: self-hosted

    steps:
    - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

    - name: Set up Python
      uses: actions/setup-python@f677139bbe7f9c59b41e40162b753c062f5d49a3 # v5.2.0
      with:
        python-version: '3.10'

    - name: Install qxub
      run: |
        python -m pip install --upgrade pip
        pip install -e .

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@8254fb75a33b976a221574d287e93919e6a36f70 # v2.1.6
      with:
        service_account: "grunner-ci-sa@${{ secrets.PROJECT_ID }}.iam.gserviceaccount.com"
        workload_identity_provider: "projects/${{ secrets.PROJECT_NUMBER }}/locations/global/workloadIdentityPools/hpci-workload-identity-pool/providers/github-provider"

    - name: Set up gcloud SDK
      uses: google-github-actions/setup-gcloud@f0990588f1e5b5af6827153b93673613abdc6ec7 # v2.1.1
      with:
        version: latest

    - name: Set up HPCI authentication
      uses: swarbricklab/hpci-scripts/.github/actions/setup-hpci@main
      with:
        submodule_token: ${{ secrets.SUBMODULE_TOKEN }}
        project_id: ${{ secrets.PROJECT_ID }}
        project_number: ${{ secrets.PROJECT_NUMBER }}
        registry_sa: ${{ secrets.REGISTRY_SA }}

    - name: Create v3.3.0 test configuration
      run: |
        # Set default project if secret is not available
        NCI_PROJECT="${{ secrets.NCI_PROJECT }}"
        if [ -z "$NCI_PROJECT" ]; then
          NCI_PROJECT="default_project"
          echo "Warning: NCI_PROJECT secret not found, using default_project"
        fi

        cat > ci_test_config.yaml << EOF
        # CI test configuration for qxub v3.3.0 remote execution (self-hosted)
        defaults:
          platform: nci_gadi
          project: $NCI_PROJECT
          walltime: "0:05:00"  # Short walltime for CI tests
          mem: 1GB
          cpus: 1
          storage: gdata/$NCI_PROJECT

        platforms:
          nci_gadi:
            remote:
              host: gadi.nci.org.au
              working_dir: /scratch/$NCI_PROJECT/{{user}}
              conda_init: |
                eval "\$(conda shell.bash hook)"
                conda activate qxub
        EOF

    - name: Test remote execution (dry run)
      run: |
        echo "Testing standard remote execution (dry run)..."
        qxub exec --config ci_test_config.yaml --platform nci_gadi --dry -vv -- echo "Hello from CI remote execution"

    - name: Test delegated remote execution (dry run)
      run: |
        echo "Testing delegated remote execution (dry run)..."
        qxub exec --config ci_test_config.yaml --platform nci_gadi --dry -vv -- echo "Hello from CI delegated execution"

    - name: Test conda environment execution (dry run)
      run: |
        echo "Testing conda environment execution (dry run)..."
        qxub exec --config ci_test_config.yaml --platform nci_gadi --env qxub --dry -vv -- python --version

    - name: Test resource specifications (dry run)
      run: |
        echo "Testing resource specifications (dry run)..."
        qxub exec --config ci_test_config.yaml --platform nci_gadi --mem 16GB --cpus 8 --time "2:00:00" --dry -vv -- echo "Resource test"

    - name: Test queue selection (dry run)
      run: |
        echo "Testing queue auto-selection (dry run)..."
        qxub exec --config ci_test_config.yaml --platform nci_gadi --queue auto --mem 128GB --dry -vv -- echo "Queue selection test"

    - name: Test template variables (dry run)
      run: |
        echo "Testing template variable resolution (dry run)..."
        qxub exec --config ci_test_config.yaml --platform nci_gadi --dry -vvv -- echo "User: \$USER, Home: \$HOME"

    - name: Test actual job submission
      if: vars.ENABLE_ACTUAL_REMOTE_TEST == 'true'
      run: |
        echo "Testing actual job submission..."
        qxub exec --config ci_test_config.yaml --platform nci_gadi --time "0:01:00" --queue copyq -vv -- echo "Actual CI job submission"

    - name: Test conda environment with real submission
      if: vars.ENABLE_ACTUAL_REMOTE_TEST == 'true'
      run: |
        echo "Testing execution with conda environment (real submission)..."
        qxub exec --config ci_test_config.yaml --platform nci_gadi --env qxub --time "0:01:00" --queue copyq -vv -- python --version

    - name: Clean up SSH keys
      if: always()
      run: |
        # Remove SSH keys for security (handled by setup-hpci action)
        rm -f atlas_key atlas_key.pub

    - name: Test local functionality
      run: |
        echo "Testing local qxub functionality..."
        qxub --version
        qxub --help
        echo "Local tests completed successfully"
