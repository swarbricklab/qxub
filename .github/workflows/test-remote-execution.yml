name: Test Remote Execution v3.3.0

on:
  push:
    branches: [ main, feature/v3.3.0-remote-execution ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allow manual trigger

jobs:
  test-remote-execution:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      HAS_SSH_KEY: ${{ secrets.GADI_SSH_PRIVATE_KEY != '' }}
      ENABLE_REAL_TESTS: ${{ secrets.ENABLE_ACTUAL_REMOTE_TEST == 'true' }}

    steps:
    - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

    - name: Set up Python
      uses: actions/setup-python@f677139bbe7f9c59b41e40162b753c062f5d49a3 # v5.2.0
      with:
        python-version: '3.10'

    - name: Install qxub
      run: |
        python -m pip install --upgrade pip
        pip install -e .

    - name: Set up SSH for Gadi
      if: env.HAS_SSH_KEY == 'true'
      run: |
        # Create SSH directory
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh

        # Add private key
        echo "${{ secrets.GADI_SSH_PRIVATE_KEY }}" > ~/.ssh/gadi_ci
        chmod 600 ~/.ssh/gadi_ci

        # Add known hosts
        echo "${{ secrets.GADI_SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts

        # Create SSH config for v3.3.0
        cat >> ~/.ssh/config << EOF
        Host gadi
          HostName gadi.nci.org.au
          User ${{ secrets.NCI_USERNAME }}
          IdentityFile ~/.ssh/gadi_ci
          StrictHostKeyChecking yes
          ServerAliveInterval 60
          ServerAliveCountMax 3
          ConnectTimeout 30
        EOF
        chmod 600 ~/.ssh/config

    - name: Create v3.3.0 test configuration
      if: env.HAS_SSH_KEY == 'true'
      run: |
        cat > ci_test_config.yaml << EOF
        # CI test configuration for qxub v3.3.0 remote execution
        defaults:
          platform: nci_gadi
          project: ${{ secrets.NCI_PROJECT }}
          walltime: "0:05:00"  # Short walltime for CI tests
          mem: 1GB
          cpus: 1
          storage: gdata/${{ secrets.NCI_PROJECT }}

        platforms:
          nci_gadi:
            remote:
              host: gadi
              working_dir: /scratch/${{ secrets.NCI_PROJECT }}/{{user}}
              conda_init: |
                eval "\$(conda shell.bash hook)"
                conda activate qxub
        EOF

    - name: Test SSH connectivity
      if: env.HAS_SSH_KEY == 'true'
      run: |
        echo "Testing SSH connection to Gadi..."
        ssh gadi "echo 'SSH connection successful' && hostname && whoami"

    - name: Test remote qxub installation
      if: env.HAS_SSH_KEY == 'true'
      run: |
        echo "Testing remote qxub installation..."
        ssh gadi "conda activate qxub && qxub --version"

    - name: Test remote execution (dry run)
      if: env.HAS_SSH_KEY == 'true'
      run: |
        echo "Testing standard remote execution (dry run)..."
        qxub exec --config ci_test_config.yaml --platform nci_gadi --dry -vv -- echo "Hello from CI remote execution"

    - name: Test delegated remote execution (dry run)
      if: env.HAS_SSH_KEY == 'true'
      run: |
        echo "Testing delegated remote execution (dry run)..."
        qxub exec --config ci_test_config.yaml --platform nci_gadi --dry -vv -- echo "Hello from CI delegated execution"

    - name: Test conda environment execution (dry run)
      if: env.HAS_SSH_KEY == 'true'
      run: |
        echo "Testing conda environment execution (dry run)..."
        qxub exec --config ci_test_config.yaml --platform nci_gadi --env qxub --dry -vv -- python --version

    - name: Test resource specifications (dry run)
      if: env.HAS_SSH_KEY == 'true'
      run: |
        echo "Testing resource specifications (dry run)..."
        qxub exec --config ci_test_config.yaml --platform nci_gadi --mem 16GB --cpus 8 --time "2:00:00" --dry -vv -- echo "Resource test"

    - name: Test queue selection (dry run)
      if: env.HAS_SSH_KEY == 'true'
      run: |
        echo "Testing queue auto-selection (dry run)..."
        qxub exec --config ci_test_config.yaml --platform nci_gadi --queue auto --mem 128GB --dry -vv -- echo "Queue selection test"

    - name: Test template variables (dry run)
      if: env.HAS_SSH_KEY == 'true'
      run: |
        echo "Testing template variable resolution (dry run)..."
        qxub exec --config ci_test_config.yaml --platform nci_gadi --dry -vvv -- echo "User: \$USER, Home: \$HOME"

    - name: Test actual job submission
      if: env.HAS_SSH_KEY == 'true' && env.ENABLE_REAL_TESTS == 'true'
      run: |
        echo "Testing actual job submission..."
        qxub exec --config ci_test_config.yaml --platform nci_gadi --time "0:01:00" --queue copyq -vv -- echo "Actual CI job submission"

    - name: Test conda environment with real submission
      if: env.HAS_SSH_KEY == 'true' && env.ENABLE_REAL_TESTS == 'true'
      run: |
        echo "Testing execution with conda environment (real submission)..."
        qxub exec --config ci_test_config.yaml --platform nci_gadi --env qxub --time "0:01:00" --queue copyq -vv -- python --version

    - name: Clean up SSH keys
      if: always()
      run: |
        # Remove SSH keys for security
        rm -f ~/.ssh/gadi_ci ~/.ssh/config
        # Keep known_hosts as it's not sensitive

    - name: Skip remote tests (no credentials)
      if: env.HAS_SSH_KEY != 'true'
      run: |
        echo "Skipping remote execution tests - no SSH credentials configured"
        echo "To enable v3.3.0 remote testing, configure these GitHub secrets:"
        echo "  - GADI_SSH_PRIVATE_KEY: SSH private key for Gadi"
        echo "  - GADI_SSH_KNOWN_HOSTS: Result of 'ssh-keyscan -H gadi.nci.org.au'"
        echo "  - NCI_USERNAME: Your Gadi username"
        echo "  - NCI_PROJECT: Your NCI project code"
        echo "  - ENABLE_ACTUAL_REMOTE_TEST: Set to 'true' to run real jobs (optional)"

    - name: Test local functionality
      run: |
        echo "Testing local qxub functionality..."
        qxub --version
        qxub --help
        echo "Local tests completed successfully"
