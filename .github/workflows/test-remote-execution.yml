name: Test Remote Execution v3.3.0

on:
  push:
    branches: [ main, feature/v3.3.0-remote-execution ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allow manual trigger

jobs:
  test-remote-execution:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install qxub
      run: |
        python -m pip install --upgrade pip
        pip install -e .

    - name: Set up SSH for Gadi
      if: ${{ secrets.GADI_SSH_PRIVATE_KEY }}
      run: |
        # Create SSH directory
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh

        # Add private key
        echo "${{ secrets.GADI_SSH_PRIVATE_KEY }}" > ~/.ssh/gadi_ci
        chmod 600 ~/.ssh/gadi_ci

        # Add known hosts
        echo "${{ secrets.GADI_SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts

        # Create SSH config for v3.3.0
        cat >> ~/.ssh/config << EOF
        Host gadi
          HostName gadi.nci.org.au
          User ${{ secrets.NCI_USERNAME }}
          IdentityFile ~/.ssh/gadi_ci
          StrictHostKeyChecking yes
          ServerAliveInterval 60
          ServerAliveCountMax 3
          ConnectTimeout 30
        EOF
        chmod 600 ~/.ssh/config

    - name: Create v3.3.0 test configuration
      if: ${{ secrets.GADI_SSH_PRIVATE_KEY }}
      run: |
        cat > ci_test_config.yaml << EOF
        # CI test configuration for qxub v3.3.0 remote execution
        defaults:
          platform: gadi_remote
          project: ${{ secrets.NCI_PROJECT }}
          walltime: "0:05:00"  # Short walltime for CI tests
          mem: 1GB
          cpus: 1
          storage: gdata/${{ secrets.NCI_PROJECT }}

        platforms:
          # Standard remote execution with definition
          gadi_remote:
            definition: https://raw.githubusercontent.com/swarbricklab/qxub-platforms/main/nci_gadi.yaml
            remote:
              host: gadi
              working_dir: /scratch/${{ secrets.NCI_PROJECT }}/{{user}}
              conda_init: |
                eval "\$(conda shell.bash hook)"
                conda activate qxub

          # Delegated remote execution (no definition)
          gadi_delegated:
            remote:
              host: gadi
              working_dir: /scratch/${{ secrets.NCI_PROJECT }}/{{user}}
              conda_init: |
                eval "\$(conda shell.bash hook)"
                conda activate qxub
        EOF

    - name: Test SSH connectivity
      if: ${{ secrets.GADI_SSH_PRIVATE_KEY }}
      run: |
        echo "Testing SSH connection to Gadi..."
        ssh gadi "echo 'SSH connection successful' && hostname && whoami"

    - name: Test remote qxub installation
      if: ${{ secrets.GADI_SSH_PRIVATE_KEY }}
      run: |
        echo "Testing remote qxub installation..."
        ssh gadi "conda activate qxub && qxub --version"

    - name: Test remote execution (dry run)
      if: ${{ secrets.GADI_SSH_PRIVATE_KEY }}
      run: |
        echo "Testing standard remote execution (dry run)..."
        qxub exec --config ci_test_config.yaml --platform gadi_remote --dry -vv -- echo "Hello from CI remote execution"

    - name: Test delegated remote execution (dry run)
      if: ${{ secrets.GADI_SSH_PRIVATE_KEY }}
      run: |
        echo "Testing delegated remote execution (dry run)..."
        qxub exec --config ci_test_config.yaml --platform gadi_delegated --dry -vv -- echo "Hello from CI delegated execution"

    - name: Test actual job submission
      if: ${{ secrets.GADI_SSH_PRIVATE_KEY && secrets.ENABLE_ACTUAL_REMOTE_TEST == 'true' }}
      run: |
        echo "Testing actual job submission..."
        qxub exec --config ci_test_config.yaml --platform gadi_remote --walltime "0:01:00" --queue copyq -vv -- echo "Actual CI job submission"

    - name: Test with conda environment
      if: ${{ secrets.GADI_SSH_PRIVATE_KEY && secrets.ENABLE_ACTUAL_REMOTE_TEST == 'true' }}
      run: |
        echo "Testing execution with conda environment..."
        qxub exec --config ci_test_config.yaml --platform gadi_remote --env qxub --walltime "0:01:00" --queue copyq -vv -- python -c "import sys; print(f'Python version: {sys.version}')"

    - name: Clean up SSH keys
      if: always()
      run: |
        # Remove SSH keys for security
        rm -f ~/.ssh/gadi_ci ~/.ssh/config
        # Keep known_hosts as it's not sensitive

    - name: Skip remote tests (no credentials)
      if: ${{ !secrets.GADI_SSH_PRIVATE_KEY }}
      run: |
        echo "Skipping remote execution tests - no SSH credentials configured"
        echo "To enable v3.3.0 remote testing, configure these GitHub secrets:"
        echo "  - GADI_SSH_PRIVATE_KEY: SSH private key for Gadi"
        echo "  - GADI_SSH_KNOWN_HOSTS: Result of 'ssh-keyscan -H gadi.nci.org.au'"
        echo "  - NCI_USERNAME: Your Gadi username"
        echo "  - NCI_PROJECT: Your NCI project code"
        echo "  - ENABLE_ACTUAL_REMOTE_TEST: Set to 'true' to run real jobs (optional)"

    - name: Test local functionality
      run: |
        echo "Testing local qxub functionality..."
        qxub --version
        qxub --help
        echo "Local tests completed successfully"
