name: Ultra Minimal - SSH Connection Test

on:
  workflow_dispatch: # Manual trigger only

jobs:
  test-ssh-connection:
    permissions:
      contents: "read"
      id-token: "write"
    runs-on: self-hosted

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up HPCI authentication
      uses: swarbricklab/hpci-scripts/.github/actions/setup-hpci@main
      with:
        submodule_token: ${{ secrets.SUBMODULE_TOKEN }}
        project_id: ${{ secrets.PROJECT_ID }}
        project_number: ${{ secrets.PROJECT_NUMBER }}
        registry_sa: ${{ secrets.REGISTRY_SA }}

    - name: Test SSH connection to NCI
      run: |
        echo "Testing SSH connection to Gadi..."
        echo "Using SSH key: ${{ github.workspace }}/atlas_key"
        ssh -i "${{ github.workspace }}/atlas_key" -o StrictHostKeyChecking=accept-new \
          ${{ secrets.USER_NAME }}@gadi.nci.org.au \
          "hostname && echo 'Connection successful!'"

    - name: Test qxub availability on NCI
      run: |
        echo "Checking if qxub is available on NCI..."
        ssh -i "${{ github.workspace }}/atlas_key" -o StrictHostKeyChecking=accept-new \
          ${{ secrets.USER_NAME }}@gadi.nci.org.au \
          'bash -l -c "conda activate qxub && which qxub && qxub --version"'

    - name: Clean up
      if: always()
      run: rm -f atlas_key atlas_key.pub
