# qxub Container-Based CI Strategy

## Problem Solved

This container-based approach solves the **OpenSSL 3.x compatibility issue** between GitHub Actions runners and hpci-scripts SSH keys:

- **Issue**: GitHub Actions Ubuntu 22.04 runners use OpenSSL 3.x, which has libcrypto incompatibility with SSH keys generated by hpci-scripts
- **Error**: `Load key: error in libcrypto`
- **Solution**: Use Ubuntu 20.04 container with OpenSSL 1.1.1 (compatible version)

## Container Architecture

### Base Image: Ubuntu 20.04
- **OpenSSL Version**: 1.1.1 (compatible with hpci-scripts keys)
- **OpenSSH Version**: Compatible with both hpci-scripts and NCI Gadi
- **Python**: 3.8+ with pip and setuptools

### Pre-installed Components
1. **System packages**: curl, wget, git, unzip, jq, openssh-client
2. **Google Cloud SDK**: Required for hpci-scripts authentication
3. **Python packages**: Common dependencies (click, pyyaml, requests)
4. **SSH environment**: Pre-configured SSH directory and environment variables

### Environment Variables
- `SSH_USE_STRONG_RNG=0`: Improves SSH key compatibility
- `DEBIAN_FRONTEND=noninteractive`: Prevents installation prompts

## Usage

### In GitHub Actions Workflows

```yaml
jobs:
  your-job:
    runs-on: self-hosted
    container:
      image: ghcr.io/swarbricklab/qxub-runner:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
```

### Benefits

1. **Compatibility**: Resolves OpenSSL 3.x issues with hpci-scripts SSH keys
2. **Speed**: Pre-installed dependencies reduce CI setup time
3. **Consistency**: Reproducible environment across all CI runs
4. **Isolation**: Container isolation prevents environment conflicts

## Container Management

### Building the Container

The container is automatically built and pushed to GitHub Container Registry when:
- `.github/docker/qxub-runner.Dockerfile` is modified
- `.github/workflows/build-runner-container.yml` is modified
- Manual trigger via workflow_dispatch

### Image Tags
- `latest`: Latest version from main branch
- `<branch>-<sha>`: Specific version for testing
- `<branch>`: Latest version from specific branch

### Registry Location
- **Registry**: `ghcr.io` (GitHub Container Registry)
- **Image**: `ghcr.io/swarbricklab/qxub-runner`
- **Visibility**: Private (requires authentication)

## Technical Details

### SSH Compatibility Stack
```
Ubuntu 20.04 Container
├── OpenSSH 8.2p1 (compatible)
├── OpenSSL 1.1.1 (compatible with hpci-scripts)
└── SSH_USE_STRONG_RNG=0 (compatibility setting)
```

### Workflow Integration
1. **Container starts** with compatible SSH environment
2. **setup-hpci action** downloads SSH keys as usual
3. **SSH keys work** without libcrypto errors
4. **qxub remote execution** succeeds

### Debugging Features
- Environment verification step shows versions
- SSH compatibility check validates key loading
- Streamlined debugging (no extensive workarounds needed)

## Maintenance

### Updating the Container
1. Modify `.github/docker/qxub-runner.Dockerfile`
2. Push changes to trigger automatic rebuild
3. Test with updated workflows

### Version Management
- Use semantic versioning tags for stable releases
- Test changes in feature branches before merging
- Monitor container size and build times

### Fallback Strategy
If container issues arise:
1. Use `ubuntu-latest` runner with compatibility workarounds
2. Apply `SSH_USE_STRONG_RNG=0` environment variable
3. Consider alternative SSH key formats if available

## Security Considerations

- Container uses official Ubuntu 20.04 base image
- Only essential packages installed
- SSH keys are temporary and cleaned up after use
- Container registry requires authentication
- No persistent storage of sensitive data

## Future Enhancements

1. **Multi-platform builds**: Support ARM64 for M1 runners
2. **Layer optimization**: Reduce container size
3. **qxub pre-installation**: Bundle specific qxub versions
4. **Conda integration**: Pre-install conda environments
5. **Cache optimization**: Leverage Docker layer caching

This container strategy provides a robust, long-term solution to the SSH compatibility issues while improving CI performance through pre-installed dependencies.
