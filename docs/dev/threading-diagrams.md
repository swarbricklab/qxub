# Threading Flow Diagrams

This document provides visual representations of the qxub threading architecture to complement the main [threading-architecture.md](threading-architecture.md) documentation.

## Thread State Diagram

```
                                    qxub starts
                                         â”‚
                                         â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚   Job Submitted     â”‚
                              â”‚                     â”‚
                              â”‚ 1. Create OutputCoordinator
                              â”‚ 2. Create log files â”‚
                              â”‚ 3. Start 4 threads  â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â–¼                â–¼                â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Monitor Thread â”‚ â”‚ Tail Threadsâ”‚ â”‚ Spinner Thread  â”‚
              â”‚                 â”‚ â”‚             â”‚ â”‚                 â”‚
              â”‚ Polls qstat     â”‚ â”‚ Follow logs â”‚ â”‚ Shows: ğŸš€ Job   â”‚
              â”‚ every 30s       â”‚ â”‚ stream I/O  â”‚ â”‚ abc123 - Waitingâ”‚
              â”‚                 â”‚ â”‚             â”‚ â”‚ with animation  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚                â”‚                â”‚
                        â”‚                â”‚                â”‚
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚        â”‚                â”‚
               â–¼        â”‚                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Job Running?    â”‚ â”‚     â”‚ Output detected?    â”‚
    â”‚                 â”‚ â”‚     â”‚                     â”‚
    â”‚ Status: R/Q     â”‚ â”‚     â”‚ First line of logs  â”‚
    â”‚ Continue poll   â”‚ â”‚     â”‚ appears             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚        â”‚                â”‚
               â”‚        â”‚                â–¼
               â”‚        â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚        â”‚     â”‚ Clear Spinner      â”‚
               â”‚        â”‚     â”‚                     â”‚
               â”‚        â”‚     â”‚ Signal output_started
               â”‚        â”‚     â”‚ Continue streaming  â”‚
               â”‚        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚        â”‚                â”‚
               â–¼        â”‚                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Job Complete?   â”‚ â”‚     â”‚ Stream Real-time    â”‚
    â”‚                 â”‚ â”‚     â”‚                     â”‚
    â”‚ Status: F/C     â”‚ â”‚     â”‚ STDOUT â†’ terminal   â”‚
    â”‚ Get exit code   â”‚ â”‚     â”‚ STDERR â†’ terminal   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚        â”‚                â”‚
               â–¼        â”‚                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Signal complete â”‚ â”‚     â”‚ Reach EOF or       â”‚
    â”‚                 â”‚ â”‚     â”‚ shutdown signal?    â”‚
    â”‚ job_completed   â”‚ â”‚     â”‚                     â”‚
    â”‚ job_exit_status â”‚ â”‚     â”‚ Signal eof_detected â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚        â”‚                â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ All threads     â”‚
                â”‚ check shutdown  â”‚
                â”‚                 â”‚
                â”‚ should_shutdown()â”‚
                â”‚ returns True    â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Graceful Exit   â”‚
                â”‚                 â”‚
                â”‚ Return job's    â”‚
                â”‚ exit status     â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Sequence Diagram

```
User    qxub       Monitor    STDOUT     STDERR     Spinner    OutputCoordinator
 â”‚        â”‚           â”‚          â”‚          â”‚          â”‚             â”‚
 â”‚  cmd   â”‚           â”‚          â”‚          â”‚          â”‚             â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â–º           â”‚          â”‚          â”‚          â”‚             â”‚
 â”‚        â”‚ create    â”‚          â”‚          â”‚          â”‚             â”‚
 â”‚        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
 â”‚        â”‚           â”‚          â”‚          â”‚          â”‚             â”‚
 â”‚        â”‚ start threads        â”‚          â”‚          â”‚             â”‚
 â”‚        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º          â”‚          â”‚          â”‚             â”‚
 â”‚        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º          â”‚          â”‚             â”‚
 â”‚        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º          â”‚             â”‚
 â”‚        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º             â”‚
 â”‚        â”‚           â”‚          â”‚          â”‚          â”‚             â”‚
 â”‚        â”‚           â”‚ poll     â”‚          â”‚          â”‚ show        â”‚
 â”‚        â”‚           â”‚ qstat    â”‚          â”‚          â”‚ spinner     â”‚
 â”‚        â”‚           â”œâ”€ â”€ â”€ â”€ â”€ â”¤          â”‚          â”œâ”€ â”€ â”€ â”€ â”€ â”€ â”¤
 â”‚        â”‚           â”‚          â”‚ follow   â”‚ follow   â”‚             â”‚
 â”‚        â”‚           â”‚          â”‚ out.log  â”‚ err.log  â”‚             â”‚
 â”‚        â”‚           â”‚          â”œâ”€ â”€ â”€ â”€ â”€ â”¤â”€ â”€ â”€ â”€ â”€ â”¤             â”‚
 â”‚        â”‚           â”‚          â”‚          â”‚          â”‚             â”‚
 â”‚        â”‚           â”‚          â”‚ output!  â”‚          â”‚             â”‚
 â”‚        â”‚           â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
 â”‚        â”‚           â”‚          â”‚          â”‚          â”‚ clear       â”‚
 â”‚        â”‚           â”‚          â”‚          â”‚          â”œâ”€ â”€ â”€ â”€ â”€ â”€ â”¤
 â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚          â”‚             â”‚
 â”‚ output â”‚           â”‚          â”‚          â”‚          â”‚             â”‚
 â”‚        â”‚           â”‚          â”‚          â”‚ error!   â”‚             â”‚
 â”‚        â”‚           â”‚          â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
 â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚             â”‚
 â”‚ error  â”‚           â”‚          â”‚          â”‚          â”‚             â”‚
 â”‚        â”‚           â”‚ complete â”‚          â”‚          â”‚             â”‚
 â”‚        â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
 â”‚        â”‚           â”‚          â”‚ EOF      â”‚ EOF      â”‚             â”‚
 â”‚        â”‚           â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
 â”‚        â”‚           â”‚          â”œâ”€ â”€ â”€ â”€ â”€ â”¤â”€ â”€ â”€ â”€ â”€ â”¤â”€ â”€ â”€ â”€ â”€ â”€ â”¤
 â”‚        â”‚           â”‚          â”‚ shutdown â”‚ shutdown â”‚ shutdown    â”‚
 â”‚        â”‚ exit      â”‚          â”‚          â”‚          â”‚             â”‚
 â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”¤           â”‚          â”‚          â”‚          â”‚             â”‚
```

## Event Timeline

```
Time â†’   0s        30s       60s       90s      120s     150s
         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚
         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚
Monitor: â”œâ”€pollingâ”€â”¼â”€pollingâ”€â”¼â”€pollingâ”€â”¼â”€completeâ”¼â”€cleanupâ”€â”¼â”€exit
         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚
STDOUT:  â”œâ”€waitingâ”€â”¼â”€waitingâ”€â”¼â”€outputâ”€â”€â”¼â”€streamâ”€â”€â”¼â”€streamâ”€â”€â”¼â”€EOF
         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚
STDERR:  â”œâ”€waitingâ”€â”¼â”€waitingâ”€â”¼â”€waitingâ”€â”¼â”€waitingâ”€â”¼â”€errorsâ”€â”€â”¼â”€EOF
         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚
Spinner: â”œâ”€activeâ”€â”€â”¼â”€activeâ”€â”€â”¼â”€clearâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€
         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚
Events:  â”‚         â”‚         â”‚ output_ â”‚ job_    â”‚         â”‚ eof_
         â”‚         â”‚         â”‚ started â”‚ completeâ”‚         â”‚ detected
```

## Control Flow for Different Scenarios

### Scenario 1: Normal Job Completion

```
Job Submit â†’ Monitor Start â†’ Spinner Show â†’ Output Start â†’ 
Clear Spinner â†’ Stream Output â†’ Job Complete â†’ Get Exit Code â†’ 
Signal Threads â†’ Cleanup â†’ Exit with Job Status
```

### Scenario 2: User Interruption (Ctrl-C)

```
Job Submit â†’ Monitor Start â†’ Spinner Show â†’ User Ctrl-C â†’ 
Signal Handler â†’ signal_shutdown() â†’ All Threads Check â†’ 
Graceful Stop â†’ Attempt Job Cleanup â†’ Exit 130
```

### Scenario 3: Job Failure

```
Job Submit â†’ Monitor Start â†’ Spinner Show â†’ Output Start â†’ 
Clear Spinner â†’ Stream Errors â†’ Job Complete (Failed) â†’ 
Get Exit Code (1) â†’ Signal Threads â†’ Cleanup â†’ Exit 1
```

### Scenario 4: Job Never Starts (Queue Wait)

```
Job Submit â†’ Monitor Start â†’ Spinner Show â†’ Poll Status (Q) â†’ 
Continue Spinner â†’ Poll Status (Q) â†’ ... â†’ Eventually Starts or Times Out
```

## Thread Communication Matrix

| Thread     | Signals                  | Waits For              | Reads From           |
|------------|--------------------------|------------------------|----------------------|
| Monitor    | job_completed            | shutdown_requested     | qstat commands       |
|            | job_exit_status          |                        |                      |
| STDOUT     | output_started           | shutdown_requested     | out.log file         |
|            | eof_detected             |                        |                      |
| STDERR     | output_started           | shutdown_requested     | err.log file         |
|            | eof_detected             |                        |                      |
| Spinner    | spinner_cleared          | output_started         | None (just displays) |
|            |                          | shutdown_requested     |                      |

## Memory and Resource Usage

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Main Process    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â‰ˆ 50MB base Python
â”‚ â”‚OutputCoord  â”‚ â”‚ â‰ˆ 1KB (events only)
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â‰ˆ 8KB each thread
â”‚ â”‚Monitor Threadâ”‚ â”‚ (minimal stack)
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚STDOUT Threadâ”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚STDERR Threadâ”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚Spinner Threadâ”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Total memory overhead: ~32KB for threading system (negligible)

## Error Propagation Flow

```
                PBS Job Exit Code
                        â”‚
                        â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Monitor detects     â”‚
              â”‚ job completion      â”‚
              â”‚ via qstat           â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Wait 5s for         â”‚
              â”‚ PBS cleanup         â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Poll for Exit_statusâ”‚
              â”‚ field every 5s      â”‚
              â”‚ (max 60s)           â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Store in            â”‚
              â”‚ coordinator.        â”‚
              â”‚ job_exit_status     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ monitor_and_tail    â”‚
              â”‚ returns exit code   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ sys.exit(job_exit_  â”‚
              â”‚ status) in conda.py â”‚
              â”‚ module.py, sing.py  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Shell sees correct  â”‚
              â”‚ exit code in $?     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```