#! /bin/bash
#PBS -N qdefault
#PBS -P a56
#PBS -l storage=gdata/a56
#PBS -S /bin/bash
#PBS -W umask=0027
#PBS -j oe

# Logging
echo "ğŸ“ Execution directory: $cwd"
echo "ğŸ”§ Default execution (no environment activation)"

# Decode base64 encoded commands
if [ -n "$cmd_b64" ]; then
    cmd=$(echo "$cmd_b64" | base64 -d)
fi
if [ -n "$pre_cmd_b64" ]; then
    pre_cmd=$(echo "$pre_cmd_b64" | base64 -d)
fi
if [ -n "$post_cmd_b64" ]; then
    post_cmd=$(echo "$post_cmd_b64" | base64 -d)
fi

echo "ğŸ’» Command: $cmd"
if [ -n "$pre_cmd" ]; then
    echo "âš¡ Pre-command: $pre_cmd"
fi
if [ -n "$post_cmd" ]; then
    echo "ğŸ Post-command: $post_cmd"
fi
echo "ğŸ“„ STDOUT file: $out"
echo "ğŸ“„ STDERR file: $err"
echo "ğŸ”‡ Quiet mode: $quiet"
if [ "$quiet" = "true" ]; then
    echo "â„¹ï¸  Note: In quiet mode, output will go to PBS joblog instead of separate files"
fi
echo "ğŸ‘¤ Current user: $(whoami)"
echo "ğŸ“ Current directory: $(pwd)"

# Strict mode with error handling
set -e

# Error handler function
error_handler() {
    local exit_code=$?
    echo "âŒ ERROR: Command failed with exit code $exit_code"
    echo "âŒ Failed command: $BASH_COMMAND"
    exit $exit_code
}

# Set trap for error handling
trap error_handler ERR

# Check required variables
if [ -z "$cmd" ]; then
    echo "âŒ ERROR: No command provided"
    exit 1
fi

if [ -z "$cwd" ]; then
    echo "âŒ ERROR: No working directory provided"
    exit 1
fi

# Change to execution directory
cd "$cwd" || { echo "âŒ ERROR: Failed to change to directory $cwd"; exit 1; }

# Set output redirection for quiet mode
if [ "$quiet" = "true" ]; then
    # In quiet mode, don't redirect stdout/stderr to files
    exec_prefix=""
else
    # Create output directories
    out_dir=$(dirname "$out")
    err_dir=$(dirname "$err")

    mkdir -p "$out_dir" "$err_dir"

    # Test write permissions
    if ! touch "$out" "$err"; then
        echo "âŒ ERROR: Cannot write to output files $out and $err"
        exit 1
    fi

    exec_prefix="exec 1>\"$out\" 2>\"$err\""
fi

# Execute pre-command if provided
if [ -n "$pre_cmd" ]; then
    echo "âš¡ Executing pre-command..."
    if [ "$quiet" = "true" ]; then
        eval "$pre_cmd"
    else
        eval "$exec_prefix; $pre_cmd"
    fi
    echo "âœ… Pre-command completed"
fi

# Execute main command
echo "ğŸ’» Executing main command..."
if [ "$quiet" = "true" ]; then
    eval "$cmd"
else
    eval "$exec_prefix; $cmd"
fi
echo "âœ… Command completed successfully"

# Execute post-command if provided
if [ -n "$post_cmd" ]; then
    echo "ğŸ Executing post-command..."
    if [ "$quiet" = "true" ]; then
        eval "$post_cmd"
    else
        eval "$exec_prefix; $post_cmd"
    fi
    echo "âœ… Post-command completed"
fi

echo "ğŸ‰ Job completed successfully"
