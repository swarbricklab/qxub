#! /bin/bash
#PBS -N qsing
#PBS -P a56
#PBS -l storage=gdata/a56
#PBS -S /bin/bash
#PBS -W umask=0027
#PBS -j oe

# Logging
echo "ğŸ“ Execution directory: $cwd"
echo "ğŸ“¦ Singularity container: $sif_file"
echo "âš™ï¸  Singularity options: $sing_options"

# Decode base64 encoded commands
if [ -n "$cmd_b64" ]; then
    cmd=$(echo "$cmd_b64" | base64 -d)
fi
if [ -n "$pre_cmd_b64" ]; then
    pre_cmd=$(echo "$pre_cmd_b64" | base64 -d)
fi
if [ -n "$post_cmd_b64" ]; then
    post_cmd=$(echo "$post_cmd_b64" | base64 -d)
fi

echo "ğŸ’» Container command: $cmd"
if [ -n "$pre_cmd" ]; then
    echo "âš¡ Pre-command: $pre_cmd"
fi
if [ -n "$post_cmd" ]; then
    echo "ğŸ Post-command: $post_cmd"
fi
echo "ğŸ“„ STDOUT: $out"
echo "ğŸ“„ STDERR: $err"
echo "ğŸ”‡ Quiet mode: $quiet"
if [ "$quiet" = "true" ]; then
    echo "â„¹ï¸  Note: In quiet mode, output will go to PBS joblog instead of separate files"
fi

# Strict mode with error handling
set -e

# Error handler function
error_handler() {
    local exit_code=$?
    echo "âŒ ERROR: Command failed with exit code $exit_code"
    echo "ğŸ’¥ Failed command: $BASH_COMMAND"
    exit $exit_code
}

# Set up error trap
trap 'error_handler' ERR

# Load singularity module
echo "ğŸ“¦ Loading singularity module"
module load singularity

# Switch work directory
echo "ğŸ“‚ Changing to working directory: $cwd"
cd $cwd

# Ensure output directories exist and files are accessible (only if not in quiet mode)
if [ "$quiet" != "true" ]; then
    echo "ğŸ“ Creating output directories for: $out and $err"
    mkdir -p "$(dirname "$out")"
    mkdir -p "$(dirname "$err")"

    # Test that we can write to the output locations
    touch "$out" || { echo "âŒ ERROR: Cannot write to $out"; exit 1; }
    touch "$err" || { echo "âŒ ERROR: Cannot write to $err"; exit 1; }
    echo "âœ… Output files verified: $out and $err"
else
    echo "ğŸ”‡ Quiet mode: skipping output file creation"
fi

# Run pre-command if specified
if [ -n "$pre_cmd" ]; then
    echo "âš¡ Running pre-command: $pre_cmd"
    bash -c "$pre_cmd"
    echo "âœ… Pre-command completed"
fi

# Run singularity command
echo "ğŸš€ Running Singularity container: $sif_file"
if [ "$quiet" = "true" ]; then
    # In quiet mode, let output go to default joblog (no redirection)
    echo "================== COMMAND OUTPUT START =================="
    if [ -n "$sing_options" ]; then
        echo "âš™ï¸  With options: $sing_options"
        bash -c "singularity exec $sing_options $sif_file $cmd"
    else
        bash -c "singularity exec $sif_file $cmd"
    fi
    echo "=================== COMMAND OUTPUT END ==================="
else
    # Normal mode: redirect to separate out/err files
    if [ -n "$sing_options" ]; then
        echo "âš™ï¸  With options: $sing_options"
        bash -c "singularity exec $sing_options $sif_file $cmd" > "$out" 2> "$err"
    else
        bash -c "singularity exec $sif_file $cmd" > "$out" 2> "$err"
    fi
fi
echo "âœ… Singularity command completed"

# Run post-command if specified and main command succeeded
if [ -n "$post_cmd" ]; then
    echo "ğŸ Running post-command: $post_cmd"
    bash -c "$post_cmd"
    echo "âœ… Post-command completed"
fi
